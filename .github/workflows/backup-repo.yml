name: Backup Repository

on:
  schedule:
    - cron: '0 0 * * *'

  pull_request:
    branches:
      - develop
    types:
      - closed

  workflow_dispatch:

env:
  AZURE_STORAGE_ACCOUNT_NAME: stappdevrepobackup01 # ---------------- the name of the azure storage account where backups will be stored
  AZURE_SUBSCRIPTION_ID: e58d5967-00f7-4556-b1fd-c3708a64f7f7 # ----- the azure subscription id where the storage account lives
  BLOB_CONTAINER_NAME: backups # ------------------------------------ the container name where we will store the backups
  FILE_NAME: <auto-generated> # ------------------------------------- var for the file name; NOTE: the file name is auto-generated below
  FILE_PATH: ${{ github.repository }} # ----------------------------- the path where the backup file will be stored; using the repo name to keep same organization as our github repos

jobs:
  backup_repository_to_azure_storage:
    name: Backup Repository to Azure Storage
    runs-on: [self-hosted, windows, x64]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 0

      - name: Generate File Name
        run: |
          $date = Get-Date
          echo "FILE_NAME=$($date.ToString('yyyyMMdd-HHmmss')).zip" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Zip Repository Files
        run: |
          7z a -r ${{ env.FILE_NAME }} .

      - name: Upload Zip File to Azure Storage
        run: >
          az login --identity

          az storage blob upload
          --auth-mode login
          --account-name ${{ env.AZURE_STORAGE_ACCOUNT_NAME }}
          --file ${{ env.FILE_NAME }}
          --container-name ${{ env.BLOB_CONTAINER_NAME }}
          --name ${{ env.FILE_PATH }}/${{ env.FILE_NAME }}
